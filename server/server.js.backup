const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const db = require('./database');
const axios = require('axios');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

console.log('ðŸš€ Socket.IO server initialized');

app.use(cors());
app.use(express.json());

// ê´€ë¦¬ìž ë¡œê·¸ì¸
app.post('/api/admin/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    const result = await db.query('SELECT * FROM admins WHERE username = $1', [username]);
    if (result.rows.length === 0) {
      return res.status(401).json({ error: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.' });
    }

    const admin = result.rows[0];
    const validPassword = await bcrypt.compare(password, admin.password_hash);
    
    if (!validPassword) {
      return res.status(401).json({ error: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.' });
    }

    const token = jwt.sign(
      { adminId: admin.id, username: admin.username },
      process.env.JWT_SECRET,
      { expiresIn: '8h' }
    );

    // ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
    await db.query('UPDATE admins SET is_online = true WHERE id = $1', [admin.id]);

    res.json({
      token,
      admin: {
        id: admin.id,
        username: admin.username,
        name: admin.name
      }
    });
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ëŒ€í™” ëª©ë¡ ì¡°íšŒ
app.get('/api/conversations', async (req, res) => {
  try {
    console.log('API: Getting conversations...');
    const result = await db.query(`
      SELECT c.id, c.session_id, c.admin_id, c.customer_name, c.status, 
             c.created_at, c.updated_at,
             COUNT(m.id) as message_count,
             MAX(m.created_at) as last_message_time
      FROM conversations c
      LEFT JOIN messages m ON c.id = m.conversation_id
      GROUP BY c.id, c.session_id, c.admin_id, c.customer_name, c.status, c.created_at, c.updated_at
      ORDER BY c.updated_at DESC
    `);
    
    console.log('API: Conversations found:', result.rows);
    res.json(result.rows);
  } catch (error) {
    console.error('Get conversations error:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// íŠ¹ì • ëŒ€í™”ì˜ ë©”ì‹œì§€ ì¡°íšŒ
app.get('/api/conversations/:id/messages', async (req, res) => {
  try {
    const { id } = req.params;
    console.log('API: Getting messages for conversation:', id);
    
    const result = await db.query(`
      SELECT m.*, a.name as admin_name
      FROM messages m
      LEFT JOIN admins a ON m.sender_id = a.id AND m.sender_type = 'admin'
      WHERE m.conversation_id = $1
      ORDER BY m.created_at ASC
    `, [id]);
    
    console.log('API: Messages found:', result.rows);
    res.json(result.rows);
  } catch (error) {
    console.error('Get messages error:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// Socket.io ì—°ê²° ì²˜ë¦¬
io.on('connection', (socket) => {
  console.log('ðŸŸ¢ User connected:', socket.id);

  // ê³ ê° ì±„íŒ… ì‹œìž‘
  socket.on('start-chat', async (data) => {
    try {
      const { sessionId, customerName } = data;
      
      // ê¸°ì¡´ ëŒ€í™” ì°¾ê¸° ë˜ëŠ” ìƒˆ ëŒ€í™” ìƒì„±
      let result = await db.query('SELECT * FROM conversations WHERE session_id = $1', [sessionId]);
      
      if (result.rows.length === 0) {
        result = await db.query(
          'INSERT INTO conversations (session_id, customer_name, status) VALUES ($1, $2, $3) RETURNING *',
          [sessionId, customerName || null, 'waiting']
        );
      }
      
      const conversation = result.rows[0];
      socket.join(`conversation_${conversation.id}`);
      
      socket.emit('chat-started', { conversationId: conversation.id });
      
      // ëª¨ë“  ê´€ë¦¬ìžì—ê²Œ ìƒˆ ì±„íŒ… ì•Œë¦¼ (ê´€ë¦¬ìžë§Œ ë°›ë„ë¡)
      socket.broadcast.emit('new-chat', conversation);
      
      console.log('New chat created:', conversation.id, 'Session:', conversation.session_id);
      
    } catch (error) {
      console.error('Start chat error:', error);
      socket.emit('error', { message: 'ì±„íŒ…ì„ ì‹œìž‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }
  });

  // ë©”ì‹œì§€ ì „ì†¡
  socket.on('send-message', async (data) => {
    try {
      const { conversationId, message, senderType, senderId } = data;
      
      console.log('ðŸ”µ Message received:', { conversationId, message, senderType });
      
      // ë©”ì‹œì§€ DB ì €ìž¥
      const result = await db.query(
        'INSERT INTO messages (conversation_id, sender_type, sender_id, message_text) VALUES ($1, $2, $3, $4) RETURNING *',
        [conversationId, senderType, senderId || null, message]
      );
      
      const newMessage = result.rows[0];
      
      // ëŒ€í™”ë°© ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
      await db.query('UPDATE conversations SET updated_at = CURRENT_TIMESTAMP WHERE id = $1', [conversationId]);
      
      console.log('Broadcasting message to conversation room:', `conversation_${conversationId}`);
      
      // í•´ë‹¹ ëŒ€í™”ë°©ì˜ ëª¨ë“  ì‚¬ìš©ìžì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
      io.to(`conversation_${conversationId}`).emit('new-message', newMessage);
      
      // ê´€ë¦¬ìžì—ê²Œë„ ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ (ëŒ€í™” ëª©ë¡ ì—…ë°ì´íŠ¸ìš©)
      socket.broadcast.emit('conversation-updated', conversationId);
      
      // ê³ ê° ë©”ì‹œì§€ì¸ ê²½ìš° AI ìžë™ ì‘ë‹µ ì²˜ë¦¬
      if (senderType === 'customer') {
        try {
          // AI ì„œë¹„ìŠ¤ì— ìš”ì²­
          const aiResponse = await axios.post('http://localhost:5000/chat', {
            message: message,
            conversation_id: conversationId
          }, {
            headers: {
              'Content-Type': 'application/json; charset=utf-8'
            }
          });
          
          if (aiResponse.data && aiResponse.data.response) {
            // AI ì‘ë‹µì„ DBì— ì €ìž¥
            const aiMessageResult = await db.query(
              'INSERT INTO messages (conversation_id, sender_type, sender_id, message_text) VALUES ($1, $2, $3, $4) RETURNING *',
              [conversationId, 'ai', null, aiResponse.data.response]
            );
            
            const aiMessage = aiMessageResult.rows[0];
            
            // ëŒ€í™”ë°© ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
            await db.query('UPDATE conversations SET updated_at = CURRENT_TIMESTAMP WHERE id = $1', [conversationId]);
            
            // AI ì‘ë‹µì„ ëŒ€í™”ë°©ì— ì „ì†¡
            setTimeout(() => {
              io.to(`conversation_${conversationId}`).emit('new-message', aiMessage);
              socket.broadcast.emit('conversation-updated', conversationId);
            }, 1000); // 1ì´ˆ ë”œë ˆì´ë¡œ ìžì—°ìŠ¤ëŸ½ê²Œ
            
            console.log('AI response sent:', aiResponse.data.response);
          }
        } catch (aiError) {
          console.error('AI service error:', aiError.message);
          // AI ì„œë¹„ìŠ¤ ì˜¤ë¥˜ ì‹œì—ë„ ê¸°ë³¸ ë©”ì‹œì§€ëŠ” ì •ìƒ ì „ì†¡ë˜ë„ë¡
        }
      }
      
    } catch (error) {
      console.error('Send message error:', error);
      socket.emit('error', { message: 'ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }
  });

  // ê´€ë¦¬ìžê°€ ëŒ€í™”ë°© ìž…ìž¥
  socket.on('join-conversation', async (data) => {
    try {
      const { conversationId, adminId } = data;
      
      socket.join(`conversation_${conversationId}`);
      
      // ëŒ€í™”ë°©ì— ê´€ë¦¬ìž ë°°ì •
      await db.query('UPDATE conversations SET admin_id = $1, status = $2 WHERE id = $3', 
        [adminId, 'active', conversationId]);
      
    } catch (error) {
      console.error('Join conversation error:', error);
      socket.emit('error', { message: 'ëŒ€í™”ë°©ì— ìž…ìž¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }
  });

  socket.on('disconnect', () => {
    console.log('User disconnected:', socket.id);
  });
});

// í˜¸í…” ê´€ë¦¬ API
// í˜¸í…” ëª©ë¡ ì¡°íšŒ
app.get('/api/hotels', async (req, res) => {
  try {
    const result = await db.query(`
      SELECT id, hotel_name, hotel_region, 
             TO_CHAR(promotion_start, 'YYYY-MM-DD') as promotion_start,
             TO_CHAR(promotion_end, 'YYYY-MM-DD') as promotion_end,
             is_unlimited, adult_price, child_price, child_criteria, description, is_active,
             created_at, updated_at
      FROM hotels WHERE is_active = true ORDER BY created_at DESC
    `);
    res.json(result.rows || result);
  } catch (error) {
    console.error('í˜¸í…” ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'í˜¸í…” ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// ìƒˆ í˜¸í…” ìƒì„±
app.post('/api/hotels', async (req, res) => {
  try {
    console.log('í˜¸í…” ìƒì„± ìš”ì²­ ë°›ìŒ:', req.body);
    const { hotel_name, hotel_region, promotion_start, promotion_end, is_unlimited, adult_price, child_price, child_criteria, description } = req.body;
    
    // ë¹ˆ ë¬¸ìžì—´ì„ nullì´ë‚˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€í™˜
    const adult_price_val = adult_price && adult_price !== '' ? parseInt(adult_price) : null;
    const child_price_val = child_price && child_price !== '' ? parseInt(child_price) : null;
    
    const result = await db.query(`
      INSERT INTO hotels (hotel_name, hotel_region, promotion_start, promotion_end, is_unlimited, adult_price, child_price, child_criteria, description)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING id, hotel_name, hotel_region, 
                TO_CHAR(promotion_start, 'YYYY-MM-DD') as promotion_start,
                TO_CHAR(promotion_end, 'YYYY-MM-DD') as promotion_end,
                is_unlimited, adult_price, child_price, child_criteria, description, is_active
    `, [
      hotel_name || '', 
      hotel_region || '', 
      promotion_start || new Date().toISOString().split('T')[0], 
      promotion_end || null, 
      is_unlimited || false, 
      adult_price_val, 
      child_price_val, 
      child_criteria || '', 
      description || ''
    ]);
    
    res.json(result.rows ? result.rows[0] : { id: result.lastID, ...req.body });
  } catch (error) {
    console.error('í˜¸í…” ìƒì„± ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'í˜¸í…”ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});


// í˜¸í…” ì •ë³´ ìˆ˜ì •
app.put('/api/hotels/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const updates = req.body;
    
    // ë°ì´í„° íƒ€ìž… ë³€í™˜
    const processedUpdates = {};
    Object.keys(updates).forEach(key => {
      let value = updates[key];
      if ((key === 'adult_price' || key === 'child_price') && value !== '' && value !== null) {
        value = parseInt(value);
      } else if ((key === 'adult_price' || key === 'child_price') && (value === '' || value === null)) {
        value = null;
      }
      processedUpdates[key] = value;
    });
    
    // ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ ìƒì„±
    const fields = Object.keys(processedUpdates);
    const values = Object.values(processedUpdates);
    const setClause = fields.map((field, index) => `${field} = $${index + 2}`).join(', ');
    
    const result = await db.query(`
      UPDATE hotels SET ${setClause}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $1
      RETURNING id, hotel_name, hotel_region, 
                TO_CHAR(promotion_start, 'YYYY-MM-DD') as promotion_start,
                TO_CHAR(promotion_end, 'YYYY-MM-DD') as promotion_end,
                is_unlimited, adult_price, child_price, child_criteria, description, is_active
    `, [id, ...values]);
    
    res.json(result.rows ? result.rows[0] : { id, ...updates });
  } catch (error) {
    console.error('í˜¸í…” ìˆ˜ì • ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'í˜¸í…” ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// í˜¸í…” ì‚­ì œ
app.delete('/api/hotels/:id', async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`í˜¸í…” ì‚­ì œ ìš”ì²­ ë°›ìŒ: ID ${id}`);
    
    // ì™„ì „ ì‚­ì œ
    const result = await db.query('DELETE FROM hotels WHERE id = $1', [id]);
    console.log(`ì‚­ì œ ê²°ê³¼:`, result.rowCount);
    
    res.json({ message: 'í˜¸í…”ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', deletedRows: result.rowCount });
  } catch (error) {
    console.error('í˜¸í…” ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'í˜¸í…”ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// íˆ¬ì–´ ê´€ë¦¬ API
// íˆ¬ì–´ ëª©ë¡ ì¡°íšŒ
app.get('/api/tours', async (req, res) => {
  try {
    const result = await db.query(`
      SELECT id, tour_name, tour_region, duration,
             adult_price, child_price, infant_price, 
             child_criteria, infant_criteria, description, is_active,
             created_at, updated_at
      FROM tours WHERE is_active = true ORDER BY created_at DESC
    `);
    res.json(result.rows || result);
  } catch (error) {
    console.error('íˆ¬ì–´ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íˆ¬ì–´ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// ìƒˆ íˆ¬ì–´ ìƒì„±
app.post('/api/tours', async (req, res) => {
  try {
    console.log('íˆ¬ì–´ ìƒì„± ìš”ì²­ ë°›ìŒ:', req.body);
    const { tour_name, tour_region, duration, adult_price, child_price, infant_price, child_criteria, infant_criteria, description } = req.body;
    
    // ë¹ˆ ë¬¸ìžì—´ì„ nullì´ë‚˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€í™˜
    const adult_price_val = adult_price && adult_price !== '' ? parseInt(adult_price) : null;
    const child_price_val = child_price && child_price !== '' ? parseInt(child_price) : null;
    const infant_price_val = infant_price && infant_price !== '' ? parseInt(infant_price) : null;
    
    const result = await db.query(`
      INSERT INTO tours (tour_name, tour_region, duration, adult_price, child_price, infant_price, child_criteria, infant_criteria, description)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING id, tour_name, tour_region, duration, adult_price, child_price, infant_price, 
                child_criteria, infant_criteria, description, is_active
    `, [
      tour_name || '', 
      tour_region || '', 
      duration || '',
      adult_price_val, 
      child_price_val, 
      infant_price_val,
      child_criteria || '', 
      infant_criteria || '',
      description || ''
    ]);
    
    console.log('íˆ¬ì–´ ìƒì„± ì‘ë‹µ:', result.rows[0]);
    res.json(result.rows ? result.rows[0] : { id: result.lastID, ...req.body });
  } catch (error) {
    console.error('íˆ¬ì–´ ìƒì„± ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íˆ¬ì–´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// íˆ¬ì–´ ì •ë³´ ìˆ˜ì •
app.put('/api/tours/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const updates = req.body;
    
    // ë°ì´í„° íƒ€ìž… ë³€í™˜
    const processedUpdates = {};
    Object.keys(updates).forEach(key => {
      let value = updates[key];
      if ((key === 'adult_price' || key === 'child_price' || key === 'infant_price') && value !== '' && value !== null) {
        value = parseInt(value);
      } else if ((key === 'adult_price' || key === 'child_price' || key === 'infant_price') && (value === '' || value === null)) {
        value = null;
      }
      processedUpdates[key] = value;
    });
    
    // ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ ìƒì„±
    const fields = Object.keys(processedUpdates);
    const values = Object.values(processedUpdates);
    const setClause = fields.map((field, index) => `${field} = $${index + 2}`).join(', ');
    
    const result = await db.query(`
      UPDATE tours SET ${setClause}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $1
      RETURNING id, tour_name, tour_region, duration, adult_price, child_price, infant_price,
                child_criteria, infant_criteria, description, is_active
    `, [id, ...values]);
    
    res.json(result.rows ? result.rows[0] : { id, ...updates });
  } catch (error) {
    console.error('íˆ¬ì–´ ìˆ˜ì • ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íˆ¬ì–´ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

// íˆ¬ì–´ ì‚­ì œ
app.delete('/api/tours/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // ì™„ì „ ì‚­ì œ
    const result = await db.query('DELETE FROM tours WHERE id = $1', [id]);
    
    res.json({ message: 'íˆ¬ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', deletedRows: result.rowCount });
  } catch (error) {
    console.error('íˆ¬ì–´ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'íˆ¬ì–´ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
});

const PORT = process.env.PORT || 3004;
server.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});