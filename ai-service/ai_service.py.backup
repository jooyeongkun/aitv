import openai
import os
import json
import re
from dotenv import load_dotenv
from database import search_hotels, search_tours

load_dotenv()

openai.api_key = os.getenv('OPENAI_API_KEY')

class TravelAI:
    def __init__(self):
        self.client = openai.OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
    
    def extract_keywords(self, user_message):
        """ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ"""
        import re
        
        # ë¹ˆ ë©”ì‹œì§€ ì²˜ë¦¬
        if not user_message or user_message.strip() == '':
            return []
        
        keywords = []
        
        # ì§€ì—­ í‚¤ì›Œë“œ
        regions = ['ë‹¤ë‚­', 'í‘¸ê¼­', 'í˜¸ì´ì•ˆ', 'ë‚˜íŠ¸ë‘', 'í˜¸ì¹˜ë¯¼', 'í•˜ë…¸ì´', 'ì œì£¼', 'ë¶€ì‚°', 'ì„œìš¸']
        for region in regions:
            if region in user_message:
                keywords.append(region)
        
        # í˜¸í…” ê´€ë ¨ í‚¤ì›Œë“œ
        hotel_keywords = ['í˜¸í…”', 'ìˆ™ë°•', 'ë¦¬ì¡°íŠ¸', 'íœì…˜', 'ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤', 'ê°ì‹¤', 'ë£¸']
        for keyword in hotel_keywords:
            if keyword in user_message:
                keywords.append(keyword)
        
        # íˆ¬ì–´ ê´€ë ¨ í‚¤ì›Œë“œ
        tour_keywords = ['íˆ¬ì–´', 'ì—¬í–‰', 'ê´€ê´‘', 'ì²´í—˜', 'ì•¡í‹°ë¹„í‹°', 'ì¼ì •']
        for keyword in tour_keywords:
            if keyword in user_message:
                keywords.append(keyword)
        
        # í•œê¸€ ë‹¨ì–´ ì¶”ì¶œ (2ê¸€ì ì´ìƒ)
        korean_words = re.findall(r'[ê°€-í£]{2,}', user_message)
        for word in korean_words:
            if word not in keywords:
                keywords.append(word)
        
        # ì˜ë¬¸ ë‹¨ì–´ ì¶”ì¶œ
        english_words = re.findall(r'[a-zA-Z]{2,}', user_message)
        for word in english_words:
            if word.lower() not in [k.lower() for k in keywords]:
                keywords.append(word)
        
        # ì¤‘ë³µ ì œê±°í•˜ê³  ìµœëŒ€ 5ê°œë§Œ
        unique_keywords = []
        for k in keywords:
            if k not in unique_keywords:
                unique_keywords.append(k)
        
        return unique_keywords[:5]
    
    def determine_intent(self, user_message):
        """ì‚¬ìš©ì ì˜ë„ íŒŒì•…"""
        user_message_lower = user_message.lower()
        
        if any(keyword in user_message_lower for keyword in ['í˜¸í…”', 'ìˆ™ë°•', 'ë¦¬ì¡°íŠ¸', 'íœì…˜']):
            return 'hotel'
        elif any(keyword in user_message_lower for keyword in ['íˆ¬ì–´', 'ê´€ê´‘', 'ì²´í—˜', 'ì•¡í‹°ë¹„í‹°']):
            return 'tour'
        elif any(keyword in user_message_lower for keyword in ['ê°€ê²©', 'ë¹„ìš©', 'ìš”ê¸ˆ', 'ì–¼ë§ˆ']):
            return 'price'
        else:
            return 'general'
    
    def search_database(self, keywords, intent):
        """ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰"""
        hotels = []
        tours = []
        
        if intent in ['hotel', 'general', 'price']:
            hotels = search_hotels(keywords)
        
        if intent in ['tour', 'general', 'price']:
            tours = search_tours(keywords)
        
        return hotels, tours
    
    def format_hotel_info(self, hotel):
        """í˜¸í…” ì •ë³´ í¬ë§·íŒ…"""
        info = f"ğŸ¨ **{hotel['hotel_name']}** ({hotel['hotel_region']})\n"
        
        if hotel['adult_price']:
            info += f"ğŸ’° ì„±ì¸: {hotel['adult_price']:,}ì›"
            if hotel['child_price']:
                info += f" / ì–´ë¦°ì´: {hotel['child_price']:,}ì›"
            info += "\n"
        
        if hotel['promotion_start'] and hotel['promotion_end']:
            if hotel['is_unlimited']:
                info += f"ğŸ“… í”„ë¡œëª¨ì…˜: ë¬´ì œí•œ\n"
            else:
                info += f"ğŸ“… í”„ë¡œëª¨ì…˜: {hotel['promotion_start']} ~ {hotel['promotion_end']}\n"
        
        if hotel['child_criteria']:
            info += f"ğŸ‘¶ ì–´ë¦°ì´ ê¸°ì¤€: {hotel['child_criteria']}\n"
        
        if hotel['description']:
            info += f"ğŸ“ {hotel['description'][:100]}{'...' if len(hotel['description']) > 100 else ''}\n"
        
        return info
    
    def format_tour_info(self, tour):
        """íˆ¬ì–´ ì •ë³´ í¬ë§·íŒ…"""
        info = f"ğŸšŒ **{tour['tour_name']}** ({tour['tour_region']})\n"
        
        if tour['duration']:
            info += f"â° ê¸°ê°„: {tour['duration']}\n"
        
        prices = []
        if tour['adult_price']:
            prices.append(f"ì„±ì¸: {tour['adult_price']:,}ì›")
        if tour['child_price']:
            prices.append(f"ì–´ë¦°ì´: {tour['child_price']:,}ì›")
        if tour['infant_price']:
            prices.append(f"ìœ ì•„: {tour['infant_price']:,}ì›")
        
        if prices:
            info += f"ğŸ’° {' / '.join(prices)}\n"
        
        if tour['child_criteria']:
            info += f"ğŸ‘¶ ì–´ë¦°ì´ ê¸°ì¤€: {tour['child_criteria']}\n"
        if tour['infant_criteria']:
            info += f"ğŸ‘¶ ìœ ì•„ ê¸°ì¤€: {tour['infant_criteria']}\n"
        
        if tour['description']:
            info += f"ğŸ“ {tour['description'][:100]}{'...' if len(tour['description']) > 100 else ''}\n"
        
        return info
    
    def generate_response(self, user_message, hotels, tours):
        """AI ì‘ë‹µ ìƒì„±"""
        try:
            # ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„
            context = f"ì‚¬ìš©ì ì§ˆë¬¸: {user_message}\n\n"
            
            if hotels:
                context += "í˜¸í…” ì •ë³´:\n"
                for hotel in hotels[:3]:  # ìµœëŒ€ 3ê°œë§Œ
                    context += self.format_hotel_info(hotel) + "\n"
            
            if tours:
                context += "íˆ¬ì–´ ì •ë³´:\n"
                for tour in tours[:3]:  # ìµœëŒ€ 3ê°œë§Œ
                    context += self.format_tour_info(tour) + "\n"
            
            if not hotels and not tours:
                return "ì£„ì†¡í•©ë‹ˆë‹¤. ìš”ì²­í•˜ì‹  ë‚´ìš©ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ë‹¤ì‹œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”."
            
            # OpenAI API í˜¸ì¶œ
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "system", 
                        "content": """ë‹¹ì‹ ì€ ì—¬í–‰ ìƒë‹´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ í˜¸í…”/íˆ¬ì–´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³ ê°ì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.

ê·œì¹™:
1. ì˜¤ì§ ì œê³µëœ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
2. ë¬´ì¡°ê±´ì ì¸ ì¶”ì²œì€ í•˜ì§€ ë§ˆì„¸ìš”
3. ê³ ê°ì˜ ì§ˆë¬¸ ì˜ë„ë¥¼ íŒŒì•…í•˜ê³  ê´€ë ¨ ì •ë³´ë§Œ ì œê³µí•˜ì„¸ìš”
4. ì •í™•í•œ ê°€ê²©ê³¼ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”
5. ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸ í†¤ì„ ì‚¬ìš©í•˜ì„¸ìš”
6. ë°ì´í„°ì— ì—†ëŠ” ë‚´ìš©ì€ "í•´ë‹¹ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ì•ˆë‚´í•˜ì„¸ìš”"""
                    },
                    {
                        "role": "user",
                        "content": context
                    }
                ],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message.content.strip()
            
        except Exception as e:
            return f"AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def process_message(self, user_message):
        """ë©”ì‹œì§€ ì²˜ë¦¬ ë©”ì¸ í•¨ìˆ˜"""
        # 1. í‚¤ì›Œë“œ ì¶”ì¶œ
        keywords = self.extract_keywords(user_message)
        
        # 2. ì˜ë„ íŒŒì•…
        intent = self.determine_intent(user_message)
        
        # 3. ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰
        hotels, tours = self.search_database(keywords, intent)
        
        # 4. AI ì‘ë‹µ ìƒì„±
        response = self.generate_response(user_message, hotels, tours)
        
        return {
            'response': response,
            'intent': intent,
            'keywords': keywords,
            'hotels_found': len(hotels),
            'tours_found': len(tours)
        }